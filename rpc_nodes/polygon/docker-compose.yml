services:
  erigon:
    image: 0xpolygon/erigon:latest
    container_name: polygon
    restart: always

    command:
      # --- Basic configuration ---
      - --datadir=/var/lib/erigon
      - --chain=bor-mainnet
      - --bor.heimdall=https://heimdall-api.polygon.technology
      - --http.addr=0.0.0.0
      - --http.api=eth,web3,net,debug,trace,txpool

      # --- Snapshot/Downloader settings ---
      # The built-in torrent downloader fails because Erigon dropped Polygon support
      # and the snapshot hash manifests return 404. Use --no-downloader to sync via P2P.
      - --torrent.download.rate=512mb
      #- --no-downloader

      # --- Sync mode (optional) ---
      # Uncomment ONE of the prune modes below (defaults to full):
      # - --prune.mode=archive
      - --prune.mode=minimal

      # --- P2P / NAT settings ---
      # Custom P2P ports to avoid conflicts with other nodes (Gnosis uses 30303, Mainnet uses 30304)
      - --port=30313
      - --p2p.allowed-ports=30313,30312
      # NAT - specify public IP since UPnP isn't available on cloud providers
      - --nat=extip:<PUBLIC_IP>
      # Polygon Bor mainnet bootnodes and static peers for peer discovery
      - --bootnodes=enode://07bc4cf87ff8f4e7dc51280991809940f26e846c944609ae4726309be73742a830040cd783989f6941e1b41c02405834bc6365059403a59ca9255ac695156235@34.89.75.187:30303,enode://2c3be2e637a68dc694498a44b6e0d57b5c762925ea97f941079a91f8a080b032fe2eb9e6c3230076e9fb046f626b5dcd3fb045dc9c194689a359aa7167ae0f6c@34.142.43.249:30303,enode://a0bc4dd2b59370d5a375a7ef9ac06cf531571005ae8b2ead2e9aaeb8205168919b169451fb0ef7061e0d80592e6ed0720f559bd1be1c4efb6e6c4381f1bdb986@35.246.99.203:30303,enode://f2b0d50e0b843d38ddcab59614f93065e2c82130100032f86ae193eb874505de12fcaf12502dfd88e339b817c0b374fa4b4f7c4d5a4d1aa04f29c503d95e0228@35.197.233.240:30303,enode://8a3f21c293c913a1148116a295aa69fdf41b9c5b0b0628d49be751aa8c025ae2ec1973d6d84cea8e2aba5541b5d76219dfaae41a124d42d0f56d4e1af50b74f8@35.246.95.65:30303,enode://f5cfe35f47ed928d5403aa28ee616fd64ed7daa527b5ae6a7bc412ca25eaad9b6bf2f776144fd9f8e7e9c80b5360a9c03b67f1d47ea88767def7d391cc7e0cd1@34.105.180.11:30303,enode://fc7624241515f9d5e599a396362c29de92b13a048ad361c90dd72286aa4cca835ba65e140a46ace70cc4dcb18472a476963750b3b69d958c5f546d48675880a8@34.147.169.102:30303,enode://7400e4bc70c56de26d5d240474a1b78af0bf8f0db567edfa851c9724ed697ca7692a92483369e9633d4342a036d10223958007160765d0317a1073f86f2a80c8@34.89.55.74:30303
      # Force persistent connections to these peers
      - --staticpeers=enode://07bc4cf87ff8f4e7dc51280991809940f26e846c944609ae4726309be73742a830040cd783989f6941e1b41c02405834bc6365059403a59ca9255ac695156235@34.89.75.187:30303,enode://2c3be2e637a68dc694498a44b6e0d57b5c762925ea97f941079a91f8a080b032fe2eb9e6c3230076e9fb046f626b5dcd3fb045dc9c194689a359aa7167ae0f6c@34.142.43.249:30303,enode://a0bc4dd2b59370d5a375a7ef9ac06cf531571005ae8b2ead2e9aaeb8205168919b169451fb0ef7061e0d80592e6ed0720f559bd1be1c4efb6e6c4381f1bdb986@35.246.99.203:30303

      # (Optional) enable WS / metrics if you need them:
      # - --ws
      # - --metrics
      # - --metrics.addr=0.0.0.0

    ports:
      # JSON-RPC
      - "9545:8545"

      # P2P for Polygon (TCP + UDP) - eth/69 on 30313, eth/68 on 30312
      - "30313:30313/tcp"
      - "30313:30313/udp"
      - "30312:30312/tcp"
      - "30312:30312/udp"

    volumes:
      # Point this at fast local/NVMe storage with plenty of space
      - $HOME/polygon/data:/var/lib/erigon

    logging:
      driver: "local"

