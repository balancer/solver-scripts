services:
  nethermind:
    image: nethermind/nethermind:latest
    container_name: gnosis-execution
    restart: unless-stopped

    command:
      # --- Basic configuration ---
      - --config=gnosis
      - --datadir=/nethermind/data
      - --JsonRpc.Enabled=true
      - --JsonRpc.Host=0.0.0.0
      - --JsonRpc.Port=8545
      - --JsonRpc.EnabledModules=eth,web3,net,txpool,subscribe
      - --JsonRpc.JwtSecretFile=/nethermind/jwt/jwt.hex
      - --JsonRpc.EngineHost=0.0.0.0
      - --JsonRpc.EnginePort=8551

      # --- Pruning (aggressive) ---
      - --Pruning.Mode=Full
      - --Pruning.FullPruningTrigger=StateDbSize
      - --Pruning.FullPruningThresholdMb=300000
      - --Pruning.FullPruningMaxDegreeOfParallelism=-1
      - --Pruning.FullPruningMemoryBudgetMb=4000

      # --- P2P / Discovery ---
      - --Network.DiscoveryPort=30303
      - --Network.P2PPort=30303

    ports:
      # JSON-RPC HTTP + WebSocket
      - "8545:8545"

      # P2P (TCP + UDP)
      - "30303:30303/tcp"
      - "30303:30303/udp"

    volumes:
      - $HOME/gnosis/execution:/nethermind/data
      - $HOME/gnosis/jwt:/nethermind/jwt:ro

    logging:
      driver: "local"

  lodestar:
    image: chainsafe/lodestar:latest
    container_name: gnosis-consensus
    restart: unless-stopped
    depends_on:
      - nethermind

    command:
      - beacon
      - --network=gnosis
      - --dataDir=/data
      - --execution.urls=http://nethermind:8551
      - --jwt-secret=/jwt/jwt.hex
      - --checkpointSyncUrl=https://checkpoint.gnosischain.com/
      - --rest
      - --rest.address=0.0.0.0
      - --rest.port=5052

    ports:
      # P2P (TCP + UDP)
      - "9000:9000/tcp"
      - "9000:9000/udp"

      # Beacon API
      - "5052:5052"

    volumes:
      - $HOME/gnosis/consensus:/data
      - $HOME/gnosis/jwt:/jwt:ro

    logging:
      driver: "local"
