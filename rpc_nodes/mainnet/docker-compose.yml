services:
  nethermind:
    image: nethermind/nethermind:latest
    container_name: ethereum-execution
    restart: unless-stopped

    command:
      # --- Basic configuration ---
      - --config=mainnet
      - --datadir=/nethermind/data
      - --JsonRpc.Enabled=true
      - --JsonRpc.Host=0.0.0.0
      - --JsonRpc.Port=8546
      - --JsonRpc.EnabledModules=eth,web3,net,txpool,subscribe
      - --JsonRpc.JwtSecretFile=/nethermind/jwt/jwt.hex
      - --JsonRpc.EngineHost=0.0.0.0
      - --JsonRpc.EnginePort=8551

      # --- Pruning (aggressive) ---
      - --Pruning.Mode=Full
      - --Pruning.FullPruningTrigger=StateDbSize
      - --Pruning.FullPruningThresholdMb=500000
      - --Pruning.FullPruningMaxDegreeOfParallelism=-1
      - --Pruning.FullPruningMemoryBudgetMb=4000

      # --- P2P / Discovery ---
      - --Network.DiscoveryPort=30304
      - --Network.P2PPort=30304

    ports:
      # JSON-RPC HTTP + WebSocket
      - "8546:8546"

      # P2P (TCP + UDP)
      - "30304:30304/tcp"
      - "30304:30304/udp"

    volumes:
      - $HOME/ethereum/execution:/nethermind/data
      - $HOME/ethereum/jwt:/nethermind/jwt:ro

    logging:
      driver: "local"

  lodestar:
    image: chainsafe/lodestar:latest
    container_name: ethereum-consensus
    restart: unless-stopped
    depends_on:
      - nethermind

    command:
      - beacon
      - --network=mainnet
      - --dataDir=/data
      - --port=9001
      - --execution.urls=http://nethermind:8551
      - --jwt-secret=/jwt/jwt.hex
      - --checkpointSyncUrl=https://beaconstate-mainnet.chainsafe.io
      - --rest
      - --rest.address=0.0.0.0
      - --rest.port=5053

    ports:
      # P2P (TCP + UDP)
      - "9001:9001/tcp"
      - "9001:9001/udp"

      # Beacon API
      - "5053:5053"

    volumes:
      - $HOME/ethereum/consensus:/data
      - $HOME/ethereum/jwt:/jwt:ro

    logging:
      driver: "local"
